@using BlazorAthenaFrontend.Models
@inject HttpClient httpClient
@using System.Security.Claims
@using BlazorAthenaFrontend.Services;
@inject BlazorAthenaFrontend.Services.TokenService TokenService
@inject BlazorAthenaFrontend.Services.JwtDecoderService JwtDecoderService


@page "/MyOrders"
@code {
    private List<Order> usersOrderList;
    private List<Product> productList;
    private List<OrderLine> orderLineList;

    protected override async Task OnInitializedAsync()
    {
        var jwtToken = TokenService.Token;
        var currentUser = CurrentUserService.GetCurrentUserFromToken(jwtToken);

        var orderList = await httpClient.GetFromJsonAsync<List<Order>>("https://localhost:7088/api/Order");
        productList = await httpClient.GetFromJsonAsync<List<Product>>("https://localhost:7088/api/Product");
        orderLineList = await httpClient.GetFromJsonAsync<List<OrderLine>>("https://localhost:7088/api/OrderLine");

        usersOrderList = orderList
            .Where(order => order.UserID == currentUser && order.Accepted == true)
            .ToList();

        // Fetch OrderLines and associated Products for each order
        foreach (var order in usersOrderList)
        {
            order.OrderLines = orderLineList
                .Where(orderLine => orderLine.OrderID == order.ID)
                .ToList();

            // Fetch Product details for each OrderLine
            foreach (var orderLine in order.OrderLines)
            {
                orderLine.Product = productList
                    .FirstOrDefault(product => product.ID == orderLine.ProductID);
            }
        }
        var currentOrder = orderList
            .Where(order => order.UserID == currentUser && order.Accepted == false)
            .ToList();
    }
}

@if (usersOrderList != null)
{
    <style>
        .accordion {
            display: flex;
            flex-direction: column;
            width: 300px;
        }

        .accordion-item {
            border: 1px solid purple;
            margin-bottom: 5px;
        }

        .accordion-header {
            padding: 10px;
            background-color: #f1f1f1;
            cursor: pointer;
        }

        .accordion-content {
            display: none;
            padding: 10px;
        }
    </style>

    <div class="accordion">
        @foreach (var order in usersOrderList)
        {
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    Receipt nr#: @order.ID Date: @order.TimeStamp.ToString("yyyy-MM-dd HH:mm:ss")
                </div>
                <div class="accordion-content">
                    @foreach (var orderLine in order.OrderLines)
                    {
                        <p>
                            @orderLine.Product.Name, Quantity: @orderLine.Quantity
                            <br />Price per product: @orderLine.Product.Price
                            <br>VAT @orderLine.Product.VAT%
                        </p>
                    }
                    <p>Total Amount: @order.SaleAmount SEK</p>
                </div>
            </div>
        }
    </div>

    <script>
        function toggleAccordion(element) {
            var content = element.nextElementSibling;
            if (content.style.display === "block") {
                content.style.display = "none";
            } else {
                content.style.display = "block";
            }
        }
    </script>
}
else
{
    <p>Loading...</p>
}
